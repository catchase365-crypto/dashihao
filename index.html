<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯·æ•™å¤§å¸ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; -webkit-font-smoothing: antialiased; overscroll-behavior: none; }
        .chat-bubble { max-width: 90%; word-wrap: break-word; position: relative; }
        /* ç”¨æˆ·çš„æ¶ˆæ¯æ°”æ³¡ */
        .chat-bubble.user { 
            background-color: #3b82f6; 
            align-self: flex-end; 
            padding: 0.75rem 1.25rem; 
            border-radius: 1.25rem;
            text-align: left;
        }
        /* å¤§å¸ˆçš„æ¶ˆæ¯æ°”æ³¡ */
        .chat-bubble.model { 
            background-color: #374151; 
            align-self: flex-start; 
            padding: 0.75rem 1.25rem; 
            border-radius: 1.25rem; 
        }
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        /* ä¾§è¾¹æ è¿‡æ¸¡ (ä»…ç§»åŠ¨ç«¯) */
        #sidebar { transition: transform 0.3s ease-in-out; }
        .context-menu { position: absolute; z-index: 100; display: none; }

        /* åé—®æŒ‰é’®çš„æ ·å¼ */
        .follow-up-btn {
            background-color: #4b5563; /* ç°è‰² */
            border: 1px solid #6b7280;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            text-align: left;
            transition: background-color 0.2s;
        }
        .follow-up-btn:hover {
            background-color: #525f73;
        }
        .follow-up-btn:disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* æ–°å¢: æœ—è¯»æŒ‰é’®æ ·å¼ */
        .speak-btn {
            background-color: #374151; /* é…åˆæ¨¡å‹æ°”æ³¡çš„é¢œè‰² */
            border-radius: 9999px; /* åœ†å½¢ */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem; /* 32px */
            height: 2rem; /* 32px */
            transition: background-color 0.2s, color 0.2s;
        }
        .speak-btn:hover {
            background-color: #4b5563;
        }
        .speak-btn.speaking {
            color: #60a5fa; /* æœ—è¯»æ—¶å˜ä¸ºè“è‰² */
        }
    </style>
</head>
<!-- 
    ä¿®æ”¹ç‚¹ 1: body ä½¿ç”¨ flex å¸ƒå±€, å®ç°ä¸‰æ  
    h-screen overflow-hidden ç¡®ä¿å æ»¡å…¨å±ä¸”ä¸æ»šåŠ¨
-->
<body class="bg-gray-900 text-gray-200 flex h-screen overflow-hidden">

    <!-- 
        ä¿®æ”¹ç‚¹ 2: å·¦ä¾§è¾¹æ  (å†å²è®°å½•)
        ç§»åŠ¨ç«¯: absolute, é»˜è®¤ -translate-x-full éšè—
        æ¡Œé¢ç«¯ (md:): relative, transform-none ä¿æŒæ˜¾ç¤º, flex å¸ƒå±€, flex-shrink-0 é˜²æ­¢è¢«å‹ç¼©
    -->
    <aside id="sidebar" class="absolute top-0 left-0 h-full w-64 bg-gray-900 border-r border-gray-700 z-40 transform -translate-x-full md:transform-none md:relative md:flex md:flex-col flex-shrink-0"></aside>
    <!-- ä¾§è¾¹æ é®ç½© (ä»…ç§»åŠ¨ç«¯) -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden"></div>

    <!-- 
        ä¿®æ”¹ç‚¹ 3: ä¸»åº”ç”¨å®¹å™¨ (ä¸­æ )
        flex-1 ä½¿å…¶å æ®å‰©ä½™ç©ºé—´ (æœ€å®½)
        ç§»é™¤ max-w-3xl, md:h-[95vh], md:rounded-2xl ç­‰é™åˆ¶
    -->
    <div id="app-container" class="flex-1 flex flex-col bg-gray-800 shadow-2xl overflow-hidden h-full">
        <!-- main-content å°†ç”± JS æ¸²æŸ“ -->
        <main id="main-content" class="flex flex-1 flex-col h-full"></main>
    </div>

    <!-- 
        ä¿®æ”¹ç‚¹ 4: æ–°å¢çš„å³ä¾§è¾¹æ  (åé—®æ¨¡å—)
        hidden md:flex: ç§»åŠ¨ç«¯éšè—, æ¡Œé¢ç«¯ flex æ˜¾ç¤º
        w-72 å›ºå®šå®½åº¦, flex-shrink-0 é˜²æ­¢è¢«å‹ç¼©
    -->
    <aside id="follow-up-bar" class="hidden md:flex md:flex-col w-72 bg-gray-900 border-l border-gray-700 flex-shrink-0">
        <div class="p-4 border-b border-gray-700">
            <h3 class="text-lg font-bold text-white">å¤§å¸ˆçš„åé—®</h3>
        </div>
        <!-- æ¡Œé¢ç«¯çš„åé—®æŒ‰é’®å®¹å™¨ -->
        <div id="options-container" class="flex-1 p-4 flex flex-col space-y-3 overflow-y-auto">
            <!-- æ¡Œé¢ç«¯çš„åé—®æŒ‰é’®å°†ç”± JS æ¸²æŸ“äºæ­¤ -->
        </div>
    </aside>

    <!-- è®¾ç½® Modals (ä¿æŒä¸å˜) -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"></div>
    <div id="topic-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"></div>

<script>
    // --- çŠ¶æ€ç®¡ç† ---
    let isLoading = false;
    let apiKey = '';
    let currentTopic = 'ç»¼åˆçŸ¥è¯†';
    let allHistories = {}; // å­˜å‚¨æ‰€æœ‰å¯¹è¯å†å²
    let currentFollowUps = []; // å½“å‰å¯ç”¨çš„åé—®

    // --- æ–°å¢: è¯­éŸ³æœ—è¯»çŠ¶æ€ ---
    let isAutoReadEnabled = localStorage.getItem('masterAutoRead') === 'true';
    const synth = window.speechSynthesis;

    // --- DOM å…ƒç´  ---
    const mainContent = document.getElementById('main-content');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const settingsModal = document.getElementById('settings-modal');
    const topicModal = document.getElementById('topic-modal');

    // --- AI é…ç½® (å·²æ›´æ–°) ---
    const BASE_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=';
    
    // æ–°çš„ JSON Schema
    const generationConfig = { 
        responseMimeType: "application/json", 
        responseSchema: { 
            type: "OBJECT", 
            properties: { 
                response_text: { type: "STRING" }, 
                follow_up_prompts: { 
                    type: "ARRAY", 
                    items: { type: "STRING" } 
                } 
            }, 
            required: ["response_text", "follow_up_prompts"] 
        } 
    };
    
    // --- è¾…åŠ©å‡½æ•° ---
    function openSettingsModal() { settingsModal.classList.remove('hidden'); document.getElementById('api-key-input').value = apiKey; }
    function closeSettingsModal() { settingsModal.classList.add('hidden'); }
    function openTopicModal() { topicModal.classList.remove('hidden'); document.getElementById('topic-input').value = currentTopic; }
    function closeTopicModal() { topicModal.classList.add('hidden'); }
    function toggleSidebar() { sidebar.classList.toggle('-translate-x-full'); sidebarOverlay.classList.toggle('hidden'); }

    function saveApiKey() { 
        const newKey = document.getElementById('api-key-input').value.trim(); 
        if (newKey) { 
            apiKey = newKey; 
            localStorage.setItem('geminiApiKey', newKey); 
            closeSettingsModal(); 
            if (!allHistories[currentTopic] || allHistories[currentTopic].history.length === 0) {
                 switchTopic(currentTopic, true);
            } 
        } else { 
            console.warn('è¯·è¾“å…¥æœ‰æ•ˆçš„ API Keyã€‚');
        } 
    }

    function saveTopicAndStart() { 
        const newTopic = document.getElementById('topic-input').value.trim(); 
        if (newTopic) { 
            closeTopicModal(); 
            switchTopic(newTopic, !allHistories[newTopic]); 
        } else { 
            console.warn('è¯·è¾“å…¥æœ‰æ•ˆçš„ä¸»é¢˜å…³é”®è¯ã€‚');
        } 
    }
    
    // --- æ–°å¢: è¯­éŸ³æœ—è¯»è¾…åŠ©å‡½æ•° ---

    /**
     * è·å–æœ—è¯»å›¾æ ‡ (å–‡å­)
     */
    function getSpeakIconSVG() {
        return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M12 12H4m8 8V4" />
                </svg>`;
    }
    
    /**
     * è·å–åœæ­¢å›¾æ ‡ (æ–¹å—)
     */
    function getStopIconSVG() {
        return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                </svg>`;
    }

    /**
     * åœæ­¢æ‰€æœ‰æœ—è¯»
     */
    function stopSpeech() {
        if (synth.speaking) {
            synth.cancel(); // è¿™ä¼šè§¦å‘ onend äº‹ä»¶
        }
    }

    /**
     * æœ—è¯»æŒ‡å®šæ–‡æœ¬
     * @param {string} text è¦æœ—è¯»çš„æ–‡æœ¬
     * @param {HTMLElement} buttonElement è§¦å‘æœ—è¯»çš„æŒ‰é’® (ç”¨äºåˆ‡æ¢å›¾æ ‡)
     */
    function speakText(text, buttonElement) {
        // å¦‚æœç‚¹å‡»çš„æŒ‰é’®å·²ç»åœ¨æœ—è¯», åˆ™åœæ­¢
        if (buttonElement && buttonElement.classList.contains('speaking')) {
            stopSpeech();
            return;
        }

        stopSpeech(); // åœæ­¢ä»»ä½•å…¶ä»–æ­£åœ¨è¿›è¡Œçš„æœ—è¯»

        if (!text || !synth) return;

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN'; // è®¾ç½®ä¸­æ–‡è¯­éŸ³

        // æ¸…ç†æ‰€æœ‰æŒ‰é’®çš„ 'speaking' çŠ¶æ€
        document.querySelectorAll('.speak-btn.speaking').forEach(btn => {
            btn.classList.remove('speaking');
            btn.innerHTML = getSpeakIconSVG();
        });

        utterance.onstart = () => {
            if (buttonElement) {
                buttonElement.classList.add('speaking');
                buttonElement.innerHTML = getStopIconSVG();
            }
        };
        
        // onend ä¼šåœ¨æœ—è¯»å®Œæˆæˆ–è¢« cancel() æ—¶è§¦å‘
        utterance.onend = () => {
            if (buttonElement) {
                buttonElement.classList.remove('speaking');
                buttonElement.innerHTML = getSpeakIconSVG();
            }
        };
        
        utterance.onerror = (event) => {
            console.error('SpeechSynthesisUtterance.onerror', event);
            if (buttonElement) {
                buttonElement.classList.remove('speaking');
                buttonElement.innerHTML = getSpeakIconSVG();
            }
        };
        
        synth.speak(utterance);
    }


    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        renderModals();
        renderSidebar(); // æ¸²æŸ“å·¦ä¾§æ 
        loadAllHistories();
        renderHistoryList();
        const lastTopic = localStorage.getItem('masterLastTopic') || 'é‡å­åŠ›å­¦';
        switchTopic(lastTopic);
        if (!loadApiKey()) openSettingsModal();
        setupGlobalEventListeners();
    }

    function setupGlobalEventListeners() {
        sidebarOverlay.addEventListener('click', toggleSidebar);
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu-parent')) closeContextMenu();
        });
    }

    // --- æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ---
    // ä¿®æ”¹ç‚¹ 5: renderChatInterface é‡å¤§æ›´æ–°
    function renderChatInterface() {
        currentMode = 'chat'; // æ¨¡å¼æ”¹ä¸º 'chat'
        mainContent.innerHTML = `
            <!-- ä¿®æ”¹ç‚¹ 6: å¤´éƒ¨ä½¿ç”¨ grid å¸ƒå±€, ç¡®ä¿æ ‡é¢˜å±…ä¸­ -->
            <header class="bg-gray-900/50 backdrop-blur-sm p-4 border-b border-gray-700 grid grid-cols-3 items-center flex-shrink-0">
                <div class="flex justify-start">
                    <!-- æ±‰å ¡æŒ‰é’®ä»…åœ¨ç§»åŠ¨ç«¯æ˜¾ç¤º (md:hidden) -->
                    <button id="sidebar-toggle-btn" title="æ‰“å¼€å†å²" class="text-gray-400 hover:text-white transition md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                </div>
                <!-- æ ‡é¢˜å±…ä¸­ -->
                <h2 id="topic-title" class="text-xl font-bold text-white truncate px-2 text-center"></h2>
                <!-- å³ä¾§æŒ‰é’®å±€å³ -->
                <div class="flex items-center space-x-4 justify-end">
                    <!-- æ–°å¢: è‡ªåŠ¨æœ—è¯»å¼€å…³ -->
                    <button id="auto-read-toggle" class="text-gray-400 hover:text-white transition p-1 rounded-full"></button>

                    <button id="topic-btn" title="è®¾ç½®ä¸»é¢˜" class="text-gray-400 hover:text-white transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                    <button id="settings-btn" title="è®¾ç½®API" class="text-gray-400 hover:text-white transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                    <button id="restart-btn" class="text-sm text-gray-400 hover:text-white transition">æ–°å¯¹è¯</button>
                </div>
            </header>
            <main id="chat-messages" class="flex-1 p-6 overflow-y-auto flex flex-col space-y-4"></main>
            <div id="loading-spinner" class="hidden p-6 flex items-center justify-center flex-shrink-0"><div class="flex items-center space-x-2 text-gray-400"><svg class="h-6 w-6 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>å¤§å¸ˆæ­£åœ¨æ€è€ƒ...</span></div></div>
            
            <!-- ä¿®æ”¹ç‚¹ 7: ç§»åŠ¨ç«¯ä¸“å±çš„åé—®æŒ‰é’®å®¹å™¨ (md:hidden) -->
            <div id="options-container-mobile" class="p-4 border-t border-gray-700 bg-gray-800 flex-shrink-0 flex flex-col space-y-3 md:hidden">
                <!-- ç§»åŠ¨ç«¯çš„åé—®æŒ‰é’®å°†ç”± JS æ¸²æŸ“äºæ­¤ -->
            </div>

            <!-- ä¿®æ”¹ç‚¹ 8: æ–°å¢çš„æ‰‹åŠ¨è¾“å…¥æ¡† (å…¨å±å¯ç”¨) -->
            <footer id="chat-input-area" class="p-4 border-t border-gray-700 bg-gray-800 flex-shrink-0">
                <div class="flex items-start space-x-2">
                    <textarea id="user-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500 resize-none" rows="1" placeholder="è¯·æ•™å¤§å¸ˆ..."></textarea>
                    <button id="send-btn" title="å‘é€" class="p-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition h-full flex items-center justify-center">
                        <!-- å‘é€å›¾æ ‡ -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
            </footer>
        `;
        // ç»‘å®šæ–°äº‹ä»¶
        document.getElementById('restart-btn').addEventListener('click', () => switchTopic(currentTopic, true));
        document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
        document.getElementById('topic-btn').addEventListener('click', openTopicModal);
        
        // ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® (ç°åœ¨å¯èƒ½ä¸å­˜åœ¨äºDOMä¸­, åŠ ä¸ªåˆ¤æ–­)
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        if (sidebarToggleBtn) {
            sidebarToggleBtn.addEventListener('click', toggleSidebar);
        }
        
        // --- æ–°å¢: è‡ªåŠ¨æœ—è¯»å¼€å…³äº‹ä»¶ ---
        const autoReadToggle = document.getElementById('auto-read-toggle');
        
        /** æ›´æ–°è‡ªåŠ¨æœ—è¯»æŒ‰é’®çš„å›¾æ ‡ */
        function updateAutoReadToggleVisual() {
            if (isAutoReadEnabled) {
                // å¼€å¯çŠ¶æ€ (å–‡å­ + æ³¢çº¹)
                autoReadToggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9 9 0 0119 10a9 9 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7 7 0 0017 10a7 7 0 00-1.757-4.95 1 1 0 010-1.414zM12.828 4.757a1 1 0 011.414 0A5 5 0 0116 10a5 5 0 01-1.757 3.536 1 1 0 11-1.414-1.414A3 3 0 0014 10a3 3 0 00-1.172-2.121 1 1 0 010-1.414z" clip-rule="evenodd" />
                                            </svg>`;
                autoReadToggle.title = "å…³é—­è‡ªåŠ¨æœ—è¯»";
            } else {
                // å…³é—­çŠ¶æ€ (å–‡å­ + X)
                autoReadToggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                            </svg>`;
                autoReadToggle.title = "å¼€å¯è‡ªåŠ¨æœ—è¯»";
            }
        }
        
        updateAutoReadToggleVisual(); // åˆå§‹åŒ–å›¾æ ‡çŠ¶æ€
        
        autoReadToggle.addEventListener('click', () => {
            isAutoReadEnabled = !isAutoReadEnabled; // åˆ‡æ¢çŠ¶æ€
            localStorage.setItem('masterAutoRead', isAutoReadEnabled); // ä¿å­˜çŠ¶æ€
            updateAutoReadToggleVisual(); // æ›´æ–°å›¾æ ‡
            if (!isAutoReadEnabled) {
                stopSpeech(); // å¦‚æœå…³é—­äº†, åœæ­¢å½“å‰æœ—è¯»
            }
        });

        // --- ä¿®æ”¹ç‚¹ 9: ä¸ºæ–°è¾“å…¥æ¡†ç»‘å®šäº‹ä»¶ ---
        const textarea = document.getElementById('user-input');
        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        textarea.addEventListener('input', () => {
            textarea.style.height = 'auto';
            // é™åˆ¶æœ€å¤§é«˜åº¦, æ¯”å¦‚ 200px
            if (textarea.scrollHeight > 200) {
                 textarea.style.height = '200px';
                 textarea.style.overflowY = 'auto';
            } else {
                 textarea.style.height = `${textarea.scrollHeight}px`;
                 textarea.style.overflowY = 'hidden';
            }
        });
        
        const sendBtn = document.getElementById('send-btn');
        const sendUserInput = () => {
            const text = textarea.value.trim();
            if (text && !isLoading) {
                // å¤ç”¨ handleFollowUpClick æ¥å‘é€æ¶ˆæ¯
                handleFollowUpClick(text); 
                textarea.value = ''; // æ¸…ç©º
                textarea.style.height = 'auto'; // é‡ç½®é«˜åº¦
            }
        };
        // å‘é€æŒ‰é’®ç‚¹å‡»
        sendBtn.addEventListener('click', sendUserInput);
        
        // Enter å‘é€, Shift+Enter æ¢è¡Œ
        textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendUserInput();
            }
        });
        
        // --- ä¿®æ”¹ç‚¹ 10: ç»‘å®šç§»åŠ¨ç«¯åé—®æŒ‰é’®å®¹å™¨çš„äº‹ä»¶ ---
        document.getElementById('options-container-mobile').addEventListener('click', (e) => {
            const button = e.target.closest('.follow-up-btn');
            if (button && !isLoading) {
                handleFollowUpClick(button.dataset.prompt);
            }
        });
        
        // --- ä¿®æ”¹ç‚¹ 11: ç»‘å®šæ¡Œé¢ç«¯ (å³æ ) åé—®æŒ‰é’®å®¹å™¨çš„äº‹ä»¶ ---
        // æ³¨æ„: è¿™ä¸ªå®¹å™¨åœ¨ HTML ç»“æ„ä¸­, è€Œé mainContent.innerHTML ä¸­
        document.getElementById('options-container').addEventListener('click', (e) => {
            const button = e.target.closest('.follow-up-btn');
            if (button && !isLoading) {
                handleFollowUpClick(button.dataset.prompt);
            }
        });
        
        document.getElementById('topic-title').textContent = currentTopic;
    }

    function renderModals() {
        // è®¾ç½® Modal
        settingsModal.innerHTML = `<div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md shadow-2xl border border-gray-700"><h2 class="text-2xl font-bold mb-4 text-white">è®¾ç½® API å¯†é’¥</h2><p class="text-gray-400 mb-6">è¯·è¾“å…¥æ‚¨çš„ Google Gemini API å¯†é’¥ã€‚</p><label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2">API KEY:</label><input type="password" id="api-key-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500"><div class="mt-6 flex justify-end space-x-4"><button id="cancel-settings-btn" class="py-2 px-5 bg-gray-600 hover:bg-gray-500 rounded-lg transition">å–æ¶ˆ</button><button id="save-settings-btn" class="py-2 px-5 bg-blue-600 hover:bg-blue-700 rounded-lg transition">ä¿å­˜</button></div></div>`;
        
        // ä¸»é¢˜ Modal (æ›´æ–°æ–‡æ¡ˆ)
        topicModal.innerHTML = `<div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md shadow-2xl border border-gray-700"><h2 class="text-2xl font-bold mb-4 text-white">è®¾ç½®è¯·æ•™ä¸»é¢˜</h2><p class="text-gray-400 mb-6">è¯·è¾“å…¥æ‚¨æƒ³è¯·æ•™çš„ä¸»é¢˜ï¼Œä¾‹å¦‚ "é‡å­åŠ›å­¦"ã€‚</p><label for="topic-input" class="block text-sm font-medium text-gray-300 mb-2">ä¸»é¢˜å…³é”®è¯:</label><input type="text" id="topic-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500"><div class="mt-6 flex justify-end space-x-4"><button id="cancel-topic-btn" class="py-2 px-5 bg-gray-600 hover:bg-gray-500 rounded-lg transition">å–æ¶ˆ</button><button id="save-topic-btn" class="py-2 px-5 bg-blue-600 hover:bg-blue-700 rounded-lg transition">å¼€å§‹è¯·æ•™</button></div></div>`;
        
        // ç»‘å®š Modal äº‹ä»¶
        document.getElementById('cancel-settings-btn').addEventListener('click', closeSettingsModal);
        document.getElementById('save-settings-btn').addEventListener('click', saveApiKey);
        document.getElementById('cancel-topic-btn').addEventListener('click', closeTopicModal);
        document.getElementById('save-topic-btn').addEventListener('click', saveTopicAndStart);
    }
    
    // ä¾§è¾¹æ  (ç§»é™¤é”™é¢˜ç›¸å…³)
    function renderSidebar() {
        sidebar.innerHTML = `
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-lg font-bold text-white">å¯¹è¯å†å²</h3>
            </div>
            <nav id="history-list" class="flex-1 overflow-y-auto p-2"></nav>
            <div class="p-4 border-t border-gray-700">
                <button id="clear-history-btn" class="w-full text-sm text-red-400 hover:text-red-300 bg-red-900/50 hover:bg-red-900/80 py-2 rounded-lg transition-colors">æ¸…é™¤æ‰€æœ‰è®°å½•</button>
            </div>
        `;
        document.getElementById('clear-history-btn').addEventListener('click', clearAllHistory);
    }
    
    // --- æ ¸å¿ƒ API è°ƒç”¨ (å·²é‡å†™) ---
    async function fetchMasterResponse(promptText) {
        if (!apiKey) { 
            openSettingsModal(); 
            return; 
        }
        setLoading(true);
        
        // æ„å»ºå¤§å¸ˆçš„ Prompt
        const systemPrompt = `ä½ æ˜¯ä¸€ä½åšå­¦å¤šè¯†çš„â€œå¤§å¸ˆâ€ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š
1.  å§‹ç»ˆæ‰®æ¼”â€œå¤§å¸ˆâ€çš„è§’è‰²ï¼Œç”¨ç®€æ´ã€æ·±åˆ»ã€å¯å‘æ€§çš„è¯­è¨€å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚
2.  ä½ çš„å›ç­” (response_text) ä¸åº”è¿‡é•¿ï¼Œä¿æŒåœ¨1-3ä¸ªæ®µè½å†…ã€‚
3.  åœ¨å›ç­”çš„æœ€åï¼Œä½ å¿…é¡»æä¾› 3 åˆ° 4 ä¸ªé«˜è´¨é‡çš„ã€å¼•å¯¼æ€§çš„â€œåé—®â€ (follow_up_prompts)ï¼Œè¿™äº›é—®é¢˜èƒ½å¸®åŠ©ç”¨æˆ·æ›´æ·±å…¥åœ°æ¢ç´¢ç›¸å…³ä¸»é¢˜ã€‚
4.  ä½ çš„å›å¤å¿…é¡»ä¸¥æ ¼éµå¾ªæŒ‡å®šçš„JSONæ ¼å¼ã€‚`;
        
        const userMessage = promptText;
        
        const payload = { 
            contents: [{ role: 'user', parts: [{ text: userMessage }] }], 
            systemInstruction: { parts: [{ text: systemPrompt }] }, 
            generationConfig 
        };
        
        try {
            const response = await fetch(BASE_API_URL + apiKey, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(payload) 
            });
            
            if (!response.ok) { 
                const errorBody = await response.json(); 
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${errorBody.error.message}`); 
            }
            
            const result = await response.json();
            const candidate = result.candidates?.[0];
            
            if (!candidate?.content?.parts?.[0]?.text) {
                throw new Error("è¿”å›çš„æ•°æ®ç»“æ„æ— æ•ˆã€‚");
            }
            
            const rawText = candidate.content.parts[0].text;
            
            try {
                // æ¸…ç†å¯èƒ½çš„ markdown æ ‡è®°
                const cleanedText = rawText.trim().replace(/```json|```/g, '').trim();
                const jsonResponse = JSON.parse(cleanedText);
                
                if (!jsonResponse.response_text || !jsonResponse.follow_up_prompts) {
                    throw new Error("è¿”å›çš„JSONç¼ºå°‘ 'response_text' æˆ– 'follow_up_prompts'ã€‚");
                }

                // æ·»åŠ åˆ°å†å²
                addHistoryItem({ type: 'model', content: jsonResponse });
                // æ¸²æŸ“åˆ°UI
                addMessageToUI(jsonResponse, 'model');
                // æ¸²æŸ“æ–°çš„åé—®æŒ‰é’®
                currentFollowUps = jsonResponse.follow_up_prompts;
                renderFollowUpButtons(currentFollowUps, true);

            } catch (parseError) { 
                handleError("JSON è§£æå¤±è´¥", rawText, parseError); 
            }
        } catch (error) { 
            handleError('è°ƒç”¨ Gemini API æ—¶å‡ºé”™', null, error); 
        } finally { 
            setLoading(false); 
        }
    }
    
    // --- äº¤äº’å¤„ç† (å·²é‡å†™) ---
    function handleFollowUpClick(promptText) {
        if (isLoading) return;
        
        stopSpeech(); // æ–°æé—®æ—¶åœæ­¢æœ—è¯»

        // 1. å°†ç”¨æˆ·çš„é€‰æ‹©æ·»åŠ åˆ°å†å²
        addHistoryItem({ type: 'user', content: promptText });
        
        // 2. å°†ç”¨æˆ·çš„é€‰æ‹©æ¸²æŸ“åˆ°UI
        addMessageToUI(promptText, 'user');
        
        // 3. æ¸…ç©ºå¹¶ç¦ç”¨æŒ‰é’®
        currentFollowUps = [];
        renderFollowUpButtons([], false); // ç¦ç”¨å¹¶æ¸…ç©º
        
        // 4. è·å–å¤§å¸ˆçš„æ–°å›å¤
        fetchMasterResponse(promptText);
    }
    
    // --- å†å²å’Œä¸»é¢˜ç®¡ç† (å·²ç®€åŒ–) ---
    function switchTopic(topic, forceNew = false) {
        stopSpeech(); // åˆ‡æ¢ä¸»é¢˜æ—¶åœæ­¢æœ—è¯»
        currentTopic = topic;
        localStorage.setItem('masterLastTopic', topic); // ä½¿ç”¨æ–°çš„ key
        renderChatInterface(); // æ¸²æŸ“èŠå¤©ç•Œé¢
        currentFollowUps = [];
        
        if (allHistories[currentTopic] && !forceNew) {
            loadChatFromHistory();
        } else {
            // åˆ›å»ºæ–°çš„å†å²
            if (!allHistories[currentTopic] || forceNew) {
                allHistories[currentTopic] = { 
                    history: [],
                    pinned: allHistories[currentTopic]?.pinned || false // ä¿ç•™å›ºå®šçŠ¶æ€
                };
            }
            saveAllHistories();
            // å°†ä¸»é¢˜ä½œä¸ºç¬¬ä¸€ä¸ªé—®é¢˜å‘é€
            handleFollowUpClick(currentTopic);
        }
        renderHistoryList();
        // ä»…åœ¨ç§»åŠ¨ç«¯è‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
        if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
           toggleSidebar();
        }
    }
    
    function loadChatFromHistory() {
        const topicData = allHistories[currentTopic] || { history: [] };
        const history = topicData.history;
        const chatMessagesEl = document.getElementById('chat-messages');
        if (!chatMessagesEl) return;
        chatMessagesEl.innerHTML = '';
        
        let lastModelItem = null;
        
        history.forEach((item, index) => {
            if (item.type === 'model') {
                addMessageToUI(item.content, 'model');
                lastModelItem = item;
            } else if (item.type === 'user') {
                addMessageToUI(item.content, 'user');
            }
        });
        
        if (lastModelItem) {
            // æ¢å¤ä¸Šä¸€è½®çš„åé—®æŒ‰é’®
            currentFollowUps = lastModelItem.content.follow_up_prompts || [];
            renderFollowUpButtons(currentFollowUps, true);
        } else {
            // å¦‚æœå†å²ä¸ºç©ºï¼Œè‡ªåŠ¨å¼€å§‹
            handleFollowUpClick(currentTopic);
        }
    }

    function addHistoryItem(item) {
        if (!allHistories[currentTopic]) allHistories[currentTopic] = { history: [], pinned: false };
        allHistories[currentTopic].history.push(item);
        saveAllHistories();
    }

    function loadAllHistories() {
        const stored = localStorage.getItem('masterAllHistories'); // æ–°çš„ key
        allHistories = stored ? JSON.parse(stored) : {};
    }

    function saveAllHistories() {
        localStorage.setItem('masterAllHistories', JSON.stringify(allHistories)); // æ–°çš„ key
        renderHistoryList();
    }



    function renderHistoryList() {
        const historyListEl = document.getElementById('history-list');
        if (!historyListEl) return;
        historyListEl.innerHTML = '';
        const topics = Object.keys(allHistories);
        
        // æ’åº (å›ºå®š > å­—æ¯)
        const sortedTopics = topics.sort((a, b) => {
            const aIsPinned = (allHistories[a] && allHistories[a].pinned);
            const bIsPinned = (allHistories[b] && allHistories[b].pinned);
            if (aIsPinned && !bIsPinned) return -1;
            if (!aIsPinned && bIsPinned) return 1;
            return a.localeCompare(b);
        });

        if (sortedTopics.length === 0) {
            historyListEl.innerHTML = `<p class="p-4 text-sm text-gray-500">è¿˜æ²¡æœ‰å¯¹è¯è®°å½•ã€‚</p>`;
            return;
        }

        sortedTopics.forEach(topic => {
            const isPinned = (allHistories[topic] && allHistories[topic].pinned);
            const wrapper = document.createElement('div');
            wrapper.className = `group flex items-center justify-between p-3 text-sm rounded-md ${topic === currentTopic ? 'bg-blue-600 text-white font-bold' : 'hover:bg-gray-700'}`;
            const link = document.createElement('a');
            link.href = "#";
            link.className = 'truncate flex-1';
            link.textContent = isPinned ? `ğŸ“Œ ${topic}` : topic;
            link.onclick = (e) => { e.preventDefault(); switchTopic(topic); };
            
            const menuButton = document.createElement('button');
            menuButton.className = 'context-menu-parent opacity-0 group-hover:opacity-100 transition-opacity ml-2 p-1 rounded-full hover:bg-gray-600';
            menuButton.innerHTML = `<svg class="h-4 w-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>`;
            menuButton.onclick = (e) => { e.stopPropagation(); showContextMenu(e.currentTarget, topic); };
            
            wrapper.appendChild(link);
            wrapper.appendChild(menuButton);
            historyListEl.appendChild(wrapper);
        });
    }
    
    // å³é”®èœå• (ç§»é™¤é”™é¢˜)
    function showContextMenu(button, topic) {
        closeContextMenu(); 
        const rect = button.getBoundingClientRect();
        const menu = document.createElement('div');
        menu.id = 'context-menu';
        menu.className = 'context-menu w-48 bg-gray-800 border border-gray-700 rounded-md shadow-lg py-1';
        menu.style.display = 'block';
        menu.style.top = `${rect.bottom}px`;
        menu.style.left = `${rect.left - 192}px`; // è°ƒæ•´ä½ç½®

        const isPinned = (allHistories[topic] && allHistories[topic].pinned);
        const pinOption = document.createElement('a');
        pinOption.href = '#';
        pinOption.textContent = isPinned ? 'å–æ¶ˆå›ºå®š' : 'å›ºå®š';
        pinOption.className = 'block px-4 py-2 text-sm hover:bg-gray-700';
        pinOption.onclick = (e) => { e.preventDefault(); togglePin(topic); closeContextMenu(); };
        
        const deleteHistoryOption = document.createElement('a');
        deleteHistoryOption.href = '#';
        deleteHistoryOption.textContent = 'æ¸…ç©ºå¯¹è¯';
        deleteHistoryOption.className = 'block px-4 py-2 text-sm hover:bg-gray-700';
        deleteHistoryOption.onclick = (e) => { e.preventDefault(); deleteHistoryOnly(topic); closeContextMenu(); };
        
        const deleteCompletelyOption = document.createElement('a');
        deleteCompletelyOption.href = '#';
        deleteCompletelyOption.textContent = 'å½»åº•åˆ é™¤';
        deleteCompletelyOption.className = 'block px-4 py-2 text-sm text-red-400 hover:bg-red-900/50';
        deleteCompletelyOption.onclick = (e) => { e.preventDefault(); deleteTopicCompletely(topic); closeContextMenu(); };

        menu.appendChild(pinOption);
        menu.appendChild(deleteHistoryOption);
        menu.appendChild(document.createElement('hr')).className = 'border-gray-700 my-1';
        menu.appendChild(deleteCompletelyOption);
        
        document.body.appendChild(menu);
    }

    function closeContextMenu() {
        const menu = document.getElementById('context-menu');
        if (menu) menu.remove();
    }
    
    function togglePin(topic) {
        if (!allHistories[topic]) return;
        allHistories[topic].pinned = !allHistories[topic].pinned;
        saveAllHistories();
    }

    function deleteHistoryOnly(topic) {
        // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†æˆ–ç®€å•çš„ç¡®è®¤
        if (confirm(`ç¡®å®šè¦æ¸…ç©ºä¸»é¢˜ "${topic}" çš„å¯¹è¯å†å²å—ï¼Ÿ`)) {
            stopSpeech(); // æ¸…ç©ºæ—¶åœæ­¢æœ—è¯»
            if (allHistories[topic]) {
                allHistories[topic].history = [];
                saveAllHistories();
                if (topic === currentTopic) {
                    switchTopic(topic, true); // é‡æ–°å¼€å§‹å½“å‰ä¸»é¢˜
                }
            }
        }
    }
    
    function deleteTopicCompletely(topic) {
        if (confirm(`è­¦å‘Šï¼šç¡®å®šè¦å½»åº•åˆ é™¤ä¸»é¢˜ "${topic}" å—ï¼Ÿ\næ‰€æœ‰å¯¹è¯å†å²éƒ½å°†è¢«æ°¸ä¹…åˆ é™¤ï¼`)) {
            stopSpeech(); // åˆ é™¤æ—¶åœæ­¢æœ—è¯»
            delete allHistories[topic];
            saveAllHistories();
            if (topic === currentTopic) {
                // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨ä¸»é¢˜ï¼Œæˆ–é»˜è®¤ä¸»é¢˜
                switchTopic(Object.keys(allHistories)[0] || 'é‡å­åŠ›å­¦', true);
            } else {
                renderHistoryList();
            }
        }
    }
    
    function clearAllHistory() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯å†å²å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
            stopSpeech(); // æ¸…é™¤æ—¶åœæ­¢æœ—è¯»
            allHistories = {};
            currentFollowUps = [];
            localStorage.removeItem('masterAllHistories');
            switchTopic('é‡å­åŠ›å­¦', true);
        }
    }

    function loadApiKey() { 
        const savedKey = localStorage.getItem('geminiApiKey'); 
        if (savedKey) { 
            apiKey = savedKey; 
            return true; 
        } 
        return false; 
    }
    
    function setLoading(loadingState) { 
        isLoading = loadingState; 
        const spinner = document.getElementById('loading-spinner');
        if (spinner) spinner.classList.toggle('hidden', !loadingState);
        
        // ç¦ç”¨/å¯ç”¨è¾“å…¥æ¡†å’ŒæŒ‰é’®
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        if (userInput) userInput.disabled = loadingState;
        if (sendBtn) sendBtn.disabled = loadingState;

        // æ¸²æŸ“æŒ‰é’®æ—¶ä¼šæ£€æŸ¥ isLoading çŠ¶æ€
        renderFollowUpButtons(currentFollowUps, !loadingState); 
    }
    
    // ä¿®æ”¹ç‚¹ 12: renderFollowUpButtons æ›´æ–°
    // ç°åœ¨éœ€è¦åŒæ—¶æ¸²æŸ“åˆ°æ¡Œé¢ç«¯ (å³æ ) å’Œç§»åŠ¨ç«¯ (åº•éƒ¨)
    function renderFollowUpButtons(prompts = [], enabled) { 
        const desktopContainerEl = document.getElementById('options-container');
        const mobileContainerEl = document.getElementById('options-container-mobile');
        
        const createButton = (promptText) => {
            const button = document.createElement('button');
            button.className = 'follow-up-btn w-full';
            button.dataset.prompt = promptText;
            button.disabled = !enabled || isLoading; // ç¡®ä¿ä¹Ÿæ£€æŸ¥ isLoading
            button.textContent = promptText;
            return button;
        };

        // æ¸²æŸ“æ¡Œé¢ç«¯
        if (desktopContainerEl) {
            desktopContainerEl.innerHTML = ''; // æ¸…ç©º
            if (prompts.length > 0) {
                prompts.forEach((promptText) => { 
                    desktopContainerEl.appendChild(createButton(promptText));
                });
            }
        }

        // æ¸²æŸ“ç§»åŠ¨ç«¯
        if (mobileContainerEl) {
            mobileContainerEl.innerHTML = ''; // æ¸…ç©º
            if (prompts.length > 0) {
                prompts.forEach((promptText) => { 
                    mobileContainerEl.appendChild(createButton(promptText));
                });
            }
        }
    }

    // æ¸²æŸ“æ¶ˆæ¯åˆ° UI (å·²ç®€åŒ–)
    // --- ä¿®æ”¹: é‡å†™ addMessageToUI ä»¥æ”¯æŒæœ—è¯»æŒ‰é’® ---
    function addMessageToUI(content, role) {
        const chatMessagesEl = document.getElementById('chat-messages');
        if (!chatMessagesEl) return;

        // åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„è¡Œå®¹å™¨
        const messageRow = document.createElement('div');
        messageRow.classList.add('w-full', 'flex'); 

        const wrapper = document.createElement('div');
        let textToSpeak = '';
        let speakButton = null; // ç”¨äºè‡ªåŠ¨æœ—è¯»

        if (role === 'model') {
            messageRow.classList.add('justify-start'); // æ¨¡å‹æ¶ˆæ¯å±…å·¦
            
            // ä½¿ç”¨ä¸€ä¸ª flex-col å®¹å™¨æ¥ç»„åˆæ°”æ³¡å’ŒæŒ‰é’®
            const modelContent = document.createElement('div');
            modelContent.classList.add('flex', 'flex-col', 'items-start', 'space-y-1');

            wrapper.classList.add('chat-bubble', 'model');
            // å°†æ¢è¡Œç¬¦ \n æ›¿æ¢ä¸º <br>ï¼Œä»¥ä¾¿åœ¨HTMLä¸­æ­£ç¡®æ˜¾ç¤º
            const formattedText = content.response_text.replace(/\n/g, '<br>');
            wrapper.innerHTML = formattedText;
            textToSpeak = content.response_text; // ä¿å­˜çº¯æ–‡æœ¬ç”¨äºæœ—è¯»
            
            modelContent.appendChild(wrapper); // æ°”æ³¡æ·»åŠ åˆ°å®¹å™¨

            // --- æ–°å¢: æœ—è¯»æŒ‰é’® ---
            speakButton = document.createElement('button');
            speakButton.className = 'speak-btn text-gray-400 hover:text-white'; // ä½¿ç”¨æ–°æ ·å¼
            speakButton.title = 'æœ—è¯»æ­¤æ¡';
            speakButton.innerHTML = getSpeakIconSVG();
            speakButton.onclick = () => {
                speakText(textToSpeak, speakButton); // ä¼ å…¥æŒ‰é’®è‡ªèº«ç”¨äºåˆ‡æ¢çŠ¶æ€
            };
            modelContent.appendChild(speakButton); // æŒ‰é’®æ·»åŠ åˆ°å®¹å™¨
            
            messageRow.appendChild(modelContent); // å®¹å™¨æ·»åŠ åˆ°è¡Œ

        } else { // user
            messageRow.classList.add('justify-end'); // ç”¨æˆ·æ¶ˆæ¯å±…å³
            wrapper.classList.add('chat-bubble', 'user');
            // éœ€è¦è½¬ä¹‰HTML, é˜²æ­¢XSS
            wrapper.textContent = content; 
            messageRow.appendChild(wrapper); // æ°”æ³¡ç›´æ¥æ·»åŠ åˆ°è¡Œ
        }
        
        chatMessagesEl.appendChild(messageRow);
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;

        // --- æ–°å¢: è‡ªåŠ¨æœ—è¯»é€»è¾‘ ---
        if (role === 'model' && isAutoReadEnabled && textToSpeak) {
            speakText(textToSpeak, speakButton); // è‡ªåŠ¨æœ—è¯»æ–°æ¶ˆæ¯
        }
    }
    
    // é”™è¯¯å¤„ç† (ä¿ç•™)
    function handleError(title, rawText, error) {
        console.error(title, error, rawText);
        setLoading(false); // ç¡®ä¿åœæ­¢åŠ è½½
        const chatMessagesEl = document.getElementById('chat-messages');
        if (!chatMessagesEl) return;
        const errorContent = `<p><strong>æŠ±æ­‰ï¼Œå‡ºé”™äº†</strong></p><p>${error.message}</p>${rawText ? `<p><small>åŸå§‹æ•°æ®: ${rawText}</small></p>` : ''}<p>è¯·æ£€æŸ¥æ‚¨çš„ API Key æˆ–ç½‘ç»œè¿æ¥ï¼Œç„¶åå°è¯•æ–°å¯¹è¯ã€‚</p>`;
        const wrapper = document.createElement('div');
        wrapper.className = 'chat-bubble model bg-red-900/50 border border-red-500';
        wrapper.innerHTML = errorContent;
        chatMessagesEl.appendChild(wrapper);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        // ç¦ç”¨åé—®æŒ‰é’®
        renderFollowUpButtons([], false);
    }

</script>
</body>
</html>


